@startuml

actor Doctor
participant "UI" as UI
participant "Gateway" as Gateway
participant "Authentication" as AuthService
participant "Audit" as AuditService
actor "Email Service" as EmailService
database "Doctors DB" as DoctorsDB
database "Audit DB" as AuditDB

== Step 1: Request password reset ==
Doctor -> UI : Insert email
UI -> Gateway : Send email
Gateway -> AuthService : Generate reset token
AuthService -> DoctorsDB : Write token hash and expiry

alt User exists
    AuthService -> EmailService : Send reset link
    AuthService -> AuditService : Log reset password event
    AuditService -> AuditDB : Write event log
end
    AuthService --> Gateway : Return generic response
    Gateway --> UI : Send message
    UI --> Doctor : Show success/error

== Step 2: User clicks email link ==
Doctor -> UI : Click reset link
UI -> Gateway : Send token, new password
Gateway -> AuthService : Verify token
AuthService -> DoctorsDB : Read token hash and check expiry

alt Token valid
    AuthService -> DoctorsDB : Update password
    AuthService -> DoctorsDB : Invalidate token
    AuthService -> AuditService : Log password reset event
    AuditService -> AuditDB : Write event log
    AuthService --> Gateway : Return success
    Gateway --> UI : Send success message
else Token invalid
    AuthService --> Gateway : Return error
    Gateway --> UI : Send error message
end

UI --> Doctor : Show success/error message

@enduml
\documentclass[12pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage{geometry}
\usepackage{longtable}
\usepackage{hyperref}
\usepackage{listings}
\usepackage{xcolor}

\geometry{margin=1in}

\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    urlcolor=cyan,
    citecolor=blue
}

\definecolor{jsonbg}{rgb}{0.95,0.95,0.95}
\lstdefinelanguage{json}{
    basicstyle=\ttfamily\footnotesize,
    numbers=left,
    numberstyle=\tiny,
    stepnumber=1,
    numbersep=5pt,
    showstringspaces=false,
    breaklines=true,
    frame=single,
    backgroundcolor=\color{jsonbg}
}

\hypersetup{
    colorlinks=true,
    linkcolor=black,  % link interni (es. indice)
    urlcolor=black,   % link URL
    citecolor=black   % riferimenti bibliografici
}

\begin{document}

\title{EarlyCare Gateway}
\author{API Documentation}
\date{}
\maketitle

\tableofcontents
\newpage

\section{Introduction}
This document describes all API endpoints of the EarlyCare Gateway system. It follows a \textbf{microservices architecture}, with a \textbf{Gateway} routing requests, an \textbf{Authentication Service} for user management and JWT issuance, a \textbf{Data Processing Service}, an \textbf{Explainable AI Service}, and an \textbf{Audit Service} for logging events.

\begin{itemize}
    \item \textbf{Communication format:} JSON (requests and responses)
    \item \textbf{Authentication:} JSON Web Token (JWT)
    \item \textbf{Error handling:} Standard HTTP status codes with JSON response
\end{itemize}

\section{User Endpoints}

\subsection{POST /register}
\begin{itemize}
    \item \textbf{Purpose:} Register a new doctor
    \item \textbf{Authentication:} None
    \item \textbf{Request Body:}
\begin{lstlisting}[language=json]
{
  "email": "doctor@example.com",
  "password": "securepassword"
}
\end{lstlisting}
    \item \textbf{Response Body (success):}
\begin{lstlisting}[language=json]
{
  "message": "User registered successfully"
}
\end{lstlisting}
    \item \textbf{Response Body (error):}
\begin{lstlisting}[language=json]
{
  "error": "Email already in use"
}
\end{lstlisting}
    \item \textbf{Status Codes:}
    \begin{itemize}
        \item 201 Created -- registration successful
        \item 400 Bad Request -- invalid input or email already exists
    \end{itemize}
    \item \textbf{Flow Notes:}
    \begin{itemize}
        \item Gateway forwards to Authentication Service
        \item Authentication Service hashes password and creates unique \texttt{doctor\_id}
        \item Asynchronous notification sent to Audit Service
    \end{itemize}
\end{itemize}

\subsection{POST /login}
\begin{itemize}
    \item \textbf{Purpose:} Authenticate doctor and issue JWT
    \item \textbf{Authentication:} None
    \item \textbf{Request Body:}
\begin{lstlisting}[language=json]
{
  "email": "doctor@example.com",
  "password": "securepassword"
}
\end{lstlisting}
    \item \textbf{Response Body (success):}
\begin{lstlisting}[language=json]
{
  "token": "<JWT>"
}
\end{lstlisting}
    \item \textbf{Response Body (error):}
\begin{lstlisting}[language=json]
{
  "error": "Invalid email or password"
}
\end{lstlisting}
    \item \textbf{Status Codes:}
    \begin{itemize}
        \item 200 OK -- login successful
        \item 401 Unauthorized -- invalid credentials
    \end{itemize}
    \item \textbf{Flow Notes:}
    \begin{itemize}
        \item JWT contains \texttt{doctor\_id} in payload, signed with secret
        \item Gateway forwards token to UI for subsequent requests
        \item Audit Service notified asynchronously
    \end{itemize}
\end{itemize}

\subsection{POST /analyse}
\begin{itemize}
    \item \textbf{Purpose:} Execute diagnosis
    \item \textbf{Authentication:} JWT required (\texttt{Authorization: Bearer <JWT>})
    \item \textbf{Request Body:}
\begin{lstlisting}[language=json]
{
  "data": "image_or_text"
}
\end{lstlisting}
    \item \textbf{Response Body (success):}
\begin{lstlisting}[language=json]
{
  "report_id": "r123456",
  "diagnosis": "Diabetes Type 2",
  "explanation": "High glucose levels detected..."
}
\end{lstlisting}
    \item \textbf{Response Body (error):}
\begin{lstlisting}[language=json]
{
  "error": "Unauthorized"
}
\end{lstlisting}
    \item \textbf{Status Codes:}
    \begin{itemize}
        \item 200 OK -- analysis completed
        \item 400 Bad Request -- invalid/missing data
        \item 401 Unauthorized -- invalid or expired JWT
    \end{itemize}
    \item \textbf{Flow Notes:}
    \begin{itemize}
        \item Gateway validates JWT via Authentication Service
        \item Gateway sends data to Data Processing Service
        \item Data Processing Service saves processed data in its database and returns \texttt{processed\_data\_id}
        \item Explainable AI retrieves data and executes model
        \item Diagnosis saved in reports database
        \item Audit Service notified asynchronously
    \end{itemize}
\end{itemize}

\subsection{GET /reports}
\begin{itemize}
    \item \textbf{Purpose:} Retrieve all reports for the doctor, optionally filtered by patient
    \item \textbf{Authentication:} JWT required (\texttt{Authorization: Bearer <JWT>})
    \item \textbf{Query Parameters (optional):} \texttt{patient\_id}
    \item \textbf{Response Body:}
\begin{lstlisting}[language=json]
[
  {
    "report_id": "r123",
    "patient_id": "p456" (optional),
    "diagnosis": "Diabetes Type 2",
    "created_at": "2025-11-14T10:00:00Z"
  }
]
\end{lstlisting}
    \item \textbf{Status Codes:}
    \begin{itemize}
        \item 200 OK -- reports retrieved
        \item 401 Unauthorized -- invalid JWT
        \item 404 Not Found -- no reports found
    \end{itemize}
    \item \textbf{Flow Notes:}
    \begin{itemize}
        \item Gateway validates JWT and extracts \texttt{doctor\_id}
        \item Calls Explainable AI to query reports database with optional \texttt{patient\_id}
    \end{itemize}
\end{itemize}

\subsection{POST /reset-password}
\begin{itemize}
    \item \textbf{Purpose:} Initiate password reset
    \item \textbf{Authentication:} None
    \item \textbf{Request Body:}
\begin{lstlisting}[language=json]
{
  "email": "doctor@example.com"
}
\end{lstlisting}
    \item \textbf{Response Body:}
\begin{lstlisting}[language=json]
{
  "message": "If your email exists, a reset link has been sent"
}
\end{lstlisting}
    \item \textbf{Status Codes:}
    \begin{itemize}
        \item 200 OK -- generic response
    \end{itemize}
    \item \textbf{Flow Notes:}
    \begin{itemize}
        \item Authentication Service generates reset token, saves hash + expiry and sends email
        \item Gateway returns generic message
    \end{itemize}
\end{itemize}

\subsection{POST /new-password}
\begin{itemize}
    \item \textbf{Purpose:} Complete password reset
    \item \textbf{Authentication:} None
    \item \textbf{Request Body:}
\begin{lstlisting}[language=json]
{
  "token": "<reset_token>",
  "new_password": "securepassword"
}
\end{lstlisting}
    \item \textbf{Response Body (success):}
\begin{lstlisting}[language=json]
{
  "message": "Password reset successfully"
}
\end{lstlisting}
    \item \textbf{Response Body (error):}
\begin{lstlisting}[language=json]
{
  "error": "Invalid or expired token"
}
\end{lstlisting}
    \item \textbf{Status Codes:}
    \begin{itemize}
        \item 200 OK -- password updated
        \item 400 Bad Request -- token invalid or expired
    \end{itemize}
    \item \textbf{Flow Notes:}
    \begin{itemize}
        \item Authentication Service validates token hash + expiry, updates password and invalidates token from the database
        \item Audit Service notified asynchronously
    \end{itemize}
\end{itemize}

\section{Internal Endpoints}
\begin{itemize}
    \item \textbf{Data Processing Service:}
    \begin{itemize}
        \item POST /process → process raw data, return \texttt{processed-data-id}
        \item GET /data/{processed-data-id} → retrieve processed data
    \end{itemize}
    \item \textbf{Authentication Service:}
    \begin{itemize}
        \item POST /validate → validate JWT, return \texttt{doctor\_id}
        \item POST /login, /register, /reset-password, /new-password
    \end{itemize}
    \item \textbf{Explainable AI Service:}
    \begin{itemize}
        \item POST /analyse → perform diagnosis
        \item GET /reports[?patient\_id=id] → list reports for doctor (optional patient)
    \end{itemize}
    \item \textbf{Audit Service:}
    \begin{itemize}
        \item POST /log → log events from other services
    \end{itemize}
\end{itemize}

\section{JWT Authentication Flow}
\begin{itemize}
    \item UI logs in → receives JWT
    \item UI sends JWT in Authorization header for protected endpoints
    \item Gateway validates JWT via Authentication Service
    \item If valid → extracts \texttt{doctor\_id} → calls internal services
    \item Internal services trust Gateway → no direct JWT validation needed
    \item \textbf{JWT payload example:}
\begin{lstlisting}[language=json]
{
  "doctor_id": "d123456",
  "exp": 1700000000,
  "iss": "AuthService"
}
\end{lstlisting}
\end{itemize}

\section{Status and Error Codes (RFC 7807)}
\begin{longtable}{|l|p{10cm}|}
\hline
\textbf{Status} & \textbf{Description} \\
\hline
200 OK & Success \\
201 Created & Resource successfully created \\
400 Bad Request & Invalid input, missing parameters \\
401 Unauthorized & Invalid/expired JWT or credentials \\
404 Not Found & Resource not found \\
500 Internal Server Error & Unexpected server error \\
\hline
\end{longtable}

\end{document}